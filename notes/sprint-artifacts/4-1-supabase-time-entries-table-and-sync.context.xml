<story-context id="4-1-supabase-time-entries-table-and-sync" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>1</storyId>
    <title>Supabase Time Entries Table and Sync</title>
    <status>drafted</status>
    <generatedAt>2026-01-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>notes/sprint-artifacts/4-1-supabase-time-entries-table-and-sync.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>power user</asA>
    <iWant>my time entries to sync to the cloud</iWant>
    <soThat>I can access my time tracking data from any device and never lose my productivity history</soThat>
    <tasks>
      <task id="1" acs="7,8,9">Create Supabase time_entries table migration</task>
      <task id="2" acs="1,3">Extend timeTrackingDb for sync metadata</task>
      <task id="3" acs="2,4,7">Create supabaseTimeEntries service module</task>
      <task id="4" acs="1,2,3,6">Create useTimeEntries hook with sync queue integration</task>
      <task id="5" acs="4,5">Implement merge logic for cross-device sync</task>
      <task id="6" acs="1">Integrate useTimeTracking with useTimeEntries</task>
      <task id="7" acs="2,6,10">Implement sync queue handling for time_entries</task>
      <task id="8" acs="6">Implement online status detection and auto-sync</task>
      <task id="9" acs="4">Update useTimeInsights to use synced entries</task>
      <task id="10" acs="10">Add sync status logging</task>
      <task id="11" acs="1-10">Write integration tests for full sync flow</task>
      <task id="12" acs="1-10">Manual browser testing</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="4.1.1">When a user stops time tracking, the time entry is saved to IndexedDB immediately with _syncStatus = 'pending'</ac>
    <ac id="4.1.2">When online, pending time entries are pushed to the Supabase time_entries table via the sync queue</ac>
    <ac id="4.1.3">Upon successful sync, the entry's _syncStatus is updated to 'synced' in IndexedDB</ac>
    <ac id="4.1.4">When the app loads on a different device (same account), time entries from Supabase are fetched and displayed</ac>
    <ac id="4.1.5">When the same entry exists locally and remotely, the one with the more recent updated_at wins (merge conflict resolution)</ac>
    <ac id="4.1.6">When offline, time entries are saved locally and sync automatically when connectivity is restored</ac>
    <ac id="4.1.7">The time_entries Supabase table has RLS policies ensuring users can only access their own entries</ac>
    <ac id="4.1.8">Indexes exist on (user_id, date) and (user_id, task_id) for efficient querying</ac>
    <ac id="4.1.9">When a referenced task is deleted, the time entry's task_id becomes null but task_name is preserved</ac>
    <ac id="4.1.10">Sync failures show a toast: "Sync failed. Will retry automatically." and retry with exponential backoff</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>notes/sprint-artifacts/tech-spec-epic-4-cross-device-sync.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Complete Spec</section>
        <snippet>Defines time_entries Supabase schema, RLS policies, sync queue extension, useTimeEntries hook interface, merge logic, and all acceptance criteria for cross-device sync.</snippet>
      </doc>
      <doc>
        <path>notes/architecture-time-tracking.md</path>
        <title>Time Tracking Architecture</title>
        <section>ADR-TT-001, ADR-TT-002</section>
        <snippet>ADR-TT-001: Active sessions in IndexedDB only. ADR-TT-002: Completed entries in Supabase with IndexedDB cache. Defines TypeScript interfaces and data flow patterns.</snippet>
      </doc>
      <doc>
        <path>notes/epics-time-tracking.md</path>
        <title>Time Tracking Epics</title>
        <section>Epic 4 Stories</section>
        <snippet>Defines Story 4.1 (Supabase sync) and Story 4.2 (Export/Backup) with acceptance criteria summaries.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>today-app/src/lib/timeTrackingDb.ts</path>
        <kind>database</kind>
        <symbol>TimeTrackingDatabase, saveTimeEntry, getTimeEntries</symbol>
        <lines>1-161</lines>
        <reason>Core IndexedDB module for time entries. Must be extended to add _syncStatus, _lastSyncAttempt fields, updateSyncStatus() and getPendingEntries() functions.</reason>
      </file>
      <file>
        <path>today-app/src/hooks/useTimeTracking.ts</path>
        <kind>hook</kind>
        <symbol>useTimeTracking, stopTracking</symbol>
        <lines>115-158</lines>
        <reason>stopTracking() creates TimeEntry and saves to IndexedDB. Must be modified to call useTimeEntries.addEntry() instead of direct saveTimeEntry() for sync queue integration.</reason>
      </file>
      <file>
        <path>today-app/src/types/timeTracking.ts</path>
        <kind>types</kind>
        <symbol>TimeEntry, ActiveSession</symbol>
        <lines>44-55</lines>
        <reason>TimeEntry interface definition. Must add CachedTimeEntry interface extending TimeEntry with _syncStatus and _lastSyncAttempt fields.</reason>
      </file>
      <file>
        <path>today-app/src/lib/syncQueue.ts</path>
        <kind>service</kind>
        <symbol>queueOperation, processQueue, coalesceOperations</symbol>
        <lines>1-490</lines>
        <reason>Existing sync queue for tasks. Reference for patterns. Must extend to handle 'time_entries' entity type with similar INSERT/UPDATE/DELETE processing.</reason>
      </file>
      <file>
        <path>today-app/src/lib/db.ts</path>
        <kind>database</kind>
        <symbol>LocalTask, SyncStatus, SyncQueueItem, SyncTable</symbol>
        <lines>1-97</lines>
        <reason>Main Dexie database with sync status patterns. Reference for SyncStatus type ('synced'|'pending'|'conflict') and _localUpdatedAt tracking.</reason>
      </file>
      <file>
        <path>today-app/src/hooks/useOnlineStatus.ts</path>
        <kind>hook</kind>
        <symbol>useOnlineStatus</symbol>
        <reason>Existing hook for online/offline detection. Reuse for auto-sync trigger when connectivity is restored.</reason>
      </file>
      <file>
        <path>today-app/src/hooks/useSyncQueue.ts</path>
        <kind>hook</kind>
        <symbol>useSyncQueue</symbol>
        <reason>React integration for sync queue. Reference for hook patterns and toast integration for conflict notifications.</reason>
      </file>
      <file>
        <path>today-app/src/hooks/useTimeInsights.ts</path>
        <kind>hook</kind>
        <symbol>useTimeInsights</symbol>
        <reason>Reads time entries from IndexedDB for insights. Must ensure it works with CachedTimeEntry format and displays entries regardless of _syncStatus.</reason>
      </file>
      <file>
        <path>today-app/src/lib/supabase.ts</path>
        <kind>client</kind>
        <symbol>supabase</symbol>
        <reason>Supabase client singleton. Use for all time_entries CRUD operations in new supabaseTimeEntries.ts module.</reason>
      </file>
      <file>
        <path>today-app/src/test/setup.ts</path>
        <kind>test-setup</kind>
        <symbol>beforeEach, fake-indexeddb</symbol>
        <lines>1-34</lines>
        <reason>Test setup with fake-indexeddb and JSDOM mocks. Must add timeTrackingDb tables to beforeEach clear if not already included.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <runtime>
          <package name="@supabase/supabase-js" version="^2.89.0">Supabase client for database operations</package>
          <package name="dexie" version="^4.2.1">IndexedDB wrapper for local cache</package>
          <package name="dexie-react-hooks" version="^4.2.0">React hooks for Dexie</package>
          <package name="date-fns" version="^4.1.0">Date formatting (format, parseISO)</package>
          <package name="react" version="^19.2.0">UI framework</package>
        </runtime>
        <devDependencies>
          <package name="typescript" version="~5.9.3">Type safety</package>
          <package name="vitest" version="^3.2.4">Unit/integration testing</package>
          <package name="fake-indexeddb" version="^6.2.5">IndexedDB mocking in tests</package>
          <package name="@testing-library/react" version="^16.3.1">React component testing</package>
          <package name="@testing-library/user-event" version="^14.6.1">User interaction testing</package>
          <package name="jsdom" version="^27.0.1">DOM environment for tests</package>
        </devDependencies>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="ADR-TT-001">Active sessions remain in IndexedDB only - never sync active sessions to Supabase</constraint>
    <constraint source="ADR-TT-002">Completed time entries use Supabase with IndexedDB cache for offline access</constraint>
    <constraint source="Tech Spec">Duration stored as milliseconds (integer), all dates as ISO 8601 strings</constraint>
    <constraint source="Tech Spec">Use crypto.randomUUID() for entry IDs to ensure uniqueness across devices</constraint>
    <constraint source="Tech Spec">task_id uses ON DELETE SET NULL to preserve entries when tasks deleted</constraint>
    <constraint source="Tech Spec">Sync uses existing sync queue pattern - batch operations, exponential backoff (1s, 2s, 4s... max 30s)</constraint>
    <constraint source="Tech Spec">Merge conflict resolution: most recent updated_at wins</constraint>
    <constraint source="Tech Spec">RLS requires all policies check auth.uid() = user_id</constraint>
    <constraint source="Story 3-3">Test baseline: 309 tests passing - maintain or increase</constraint>
    <constraint source="Patterns">Dev logging pattern: if (import.meta.env.DEV) console.log('[Today] ...')</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>TimeEntry</name>
      <kind>TypeScript interface</kind>
      <signature>
interface TimeEntry {
  id: string;              // UUID (crypto.randomUUID())
  user_id: string;         // References auth.users
  task_id: string | null;  // References tasks (null if task deleted)
  task_name: string;       // Snapshot of task name at creation
  start_time: string;      // ISO 8601 timestamp
  end_time: string;        // ISO 8601 timestamp
  duration: number;        // Milliseconds
  date: string;            // YYYY-MM-DD for grouping/filtering
  created_at: string;      // ISO 8601 timestamp
  updated_at: string;      // ISO 8601 timestamp
}
      </signature>
      <path>today-app/src/types/timeTracking.ts:44-55</path>
    </interface>
    <interface>
      <name>CachedTimeEntry (to create)</name>
      <kind>TypeScript interface</kind>
      <signature>
interface CachedTimeEntry extends TimeEntry {
  _syncStatus: 'synced' | 'pending' | 'error';
  _lastSyncAttempt?: string;  // ISO 8601 timestamp
}
      </signature>
      <path>today-app/src/types/timeTracking.ts (NEW)</path>
    </interface>
    <interface>
      <name>useTimeEntries (to create)</name>
      <kind>React hook</kind>
      <signature>
interface UseTimeEntriesReturn {
  entries: TimeEntry[];
  isLoading: boolean;
  error: Error | null;
  addEntry: (entry: Omit&lt;TimeEntry, 'id' | 'created_at' | 'updated_at'&gt;) =&gt; Promise&lt;TimeEntry&gt;;
  deleteEntry: (id: string) =&gt; Promise&lt;void&gt;;
  syncEntries: () =&gt; Promise&lt;void&gt;;
  pendingCount: number;
}
function useTimeEntries(): UseTimeEntriesReturn;
      </signature>
      <path>today-app/src/hooks/useTimeEntries.ts (NEW)</path>
    </interface>
    <interface>
      <name>supabaseTimeEntries (to create)</name>
      <kind>Service module</kind>
      <signature>
async function fetchTimeEntries(userId: string, since?: string): Promise&lt;TimeEntry[]&gt;;
async function upsertTimeEntry(entry: TimeEntry): Promise&lt;TimeEntry&gt;;
async function deleteTimeEntry(id: string): Promise&lt;void&gt;;
async function batchUpsertTimeEntries(entries: TimeEntry[]): Promise&lt;TimeEntry[]&gt;;
      </signature>
      <path>today-app/src/lib/supabaseTimeEntries.ts (NEW)</path>
    </interface>
    <interface>
      <name>SyncQueueItem (extended)</name>
      <kind>TypeScript interface</kind>
      <signature>
interface SyncQueueItem {
  id: string;
  operation: 'INSERT' | 'UPDATE' | 'DELETE';
  table: 'tasks' | 'categories' | 'time_entries';  // Extended
  entityId: string;
  payload: string;
  createdAt: string;
  retryCount: number;
}
      </signature>
      <path>today-app/src/lib/db.ts:40-48</path>
    </interface>
    <interface>
      <name>Supabase time_entries table</name>
      <kind>SQL DDL</kind>
      <signature>
CREATE TABLE time_entries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  task_id UUID REFERENCES tasks(id) ON DELETE SET NULL,
  task_name TEXT NOT NULL,
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ NOT NULL,
  duration INTEGER NOT NULL,
  date DATE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
      </signature>
      <path>Supabase Migration (apply via MCP)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Testing uses Vitest with fake-indexeddb for IndexedDB mocking. Tests are co-located with source files (*.test.ts). React component tests use @testing-library/react and @testing-library/user-event. Test setup in src/test/setup.ts clears all database tables before each test. Console logs are suppressed in test environment unless debugging. Mock Supabase client for network operations. Current baseline: 309 tests passing.
    </standards>
    <locations>
      <location>today-app/src/**/*.test.ts</location>
      <location>today-app/src/test/setup.ts</location>
    </locations>
    <ideas>
      <idea ac="4.1.1">Test stopTracking creates entry in IndexedDB with _syncStatus='pending'</idea>
      <idea ac="4.1.2">Test online sync queue processes time_entries INSERT to Supabase (mock client)</idea>
      <idea ac="4.1.3">Test successful sync updates _syncStatus to 'synced' in IndexedDB</idea>
      <idea ac="4.1.4">Test app load fetches entries from Supabase and merges with IndexedDB</idea>
      <idea ac="4.1.5">Test merge logic: remote entry with newer updated_at replaces local</idea>
      <idea ac="4.1.5">Test merge logic: local entry with newer updated_at is preserved</idea>
      <idea ac="4.1.6">Test offline: entry saved locally, syncs when navigator.onLine becomes true</idea>
      <idea ac="4.1.7">Test RLS: SQL verification that policies require auth.uid() = user_id</idea>
      <idea ac="4.1.8">Test migration creates indexes on (user_id, date) and (user_id, task_id)</idea>
      <idea ac="4.1.9">Test task deletion: time entry preserved with null task_id, task_name intact</idea>
      <idea ac="4.1.10">Test sync failure: toast shown, retry scheduled with exponential backoff</idea>
      <idea ac="all">Integration test: full flow from stop tracking to synced entry visible on another device</idea>
    </ideas>
  </tests>
</story-context>
