<story-context id="2-1-platform-detection-utility" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>Platform Detection Utility</title>
    <status>drafted</status>
    <generatedAt>2026-01-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>notes/sprint-artifacts/2-1-platform-detection-utility.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>a utility function to detect if the app is running in Electron</iWant>
    <soThat>I can conditionally enable desktop features</soThat>
    <tasks>
      <task id="1" ac="1.1,1.4">
        <name>Create platform detection module</name>
        <subtasks>
          <subtask>1.1: Create `src/lib/platform.ts` file</subtask>
          <subtask>1.2: Implement `isElectron()` function with proper TypeScript typing</subtask>
          <subtask>1.3: Export function as named export for tree-shaking compatibility</subtask>
        </subtasks>
      </task>
      <task id="2" ac="1.2,1.3,1.5">
        <name>Implement detection logic</name>
        <subtasks>
          <subtask>2.1: Check `typeof window !== 'undefined'` for SSR safety</subtask>
          <subtask>2.2: Check `'electronAPI' in window` for Electron detection</subtask>
          <subtask>2.3: Check `window.electronAPI !== undefined` as final verification</subtask>
          <subtask>2.4: Return boolean result combining all checks</subtask>
        </subtasks>
      </task>
      <task id="3" ac="1.6">
        <name>Verify build compatibility</name>
        <subtasks>
          <subtask>3.1: Run `npm run build` - verify no errors</subtask>
          <subtask>3.2: Run `tsc -b` - verify TypeScript compiles cleanly</subtask>
          <subtask>3.3: Verify function doesn't cause issues during SSR/build phase</subtask>
        </subtasks>
      </task>
      <task id="4" ac="1.2,1.3">
        <name>Test in both environments</name>
        <subtasks>
          <subtask>4.1: Run `npm run dev:electron` - test `isElectron()` returns `true`</subtask>
          <subtask>4.2: Run `npm run dev` - test `isElectron()` returns `false` in browser</subtask>
          <subtask>4.3: Document test results in Dev Agent Record</subtask>
        </subtasks>
      </task>
      <task id="5" ac="1.1-1.6">
        <name>Write unit tests</name>
        <subtasks>
          <subtask>5.1: Create `src/lib/platform.test.ts`</subtask>
          <subtask>5.2: Test: returns false when `window` is undefined (SSR case)</subtask>
          <subtask>5.3: Test: returns false when `window.electronAPI` is not present</subtask>
          <subtask>5.4: Test: returns true when `window.electronAPI` is present</subtask>
          <subtask>5.5: Run `npm test` - verify all tests pass</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1.1">`src/lib/platform.ts` exports an `isElectron()` function</criterion>
    <criterion id="AC1.2">In Electron: `isElectron()` returns `true`</criterion>
    <criterion id="AC1.3">In web browser: `isElectron()` returns `false`</criterion>
    <criterion id="AC1.4">TypeScript types are correct (function returns `boolean`)</criterion>
    <criterion id="AC1.5">Function handles SSR/build case (`typeof window === 'undefined'`) gracefully</criterion>
    <criterion id="AC1.6">Function works during Vite build without errors</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>notes/sprint-artifacts/tech-spec-epic-2-electron.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>AC1: Platform Detection Utility</section>
        <snippet>Defines all 6 acceptance criteria for isElectron() function including SSR handling and build compatibility requirements.</snippet>
      </doc>
      <doc>
        <path>notes/architecture-electron-migration.md</path>
        <title>Electron Migration Architecture</title>
        <section>Feature Detection Pattern</section>
        <snippet>Defines isElectron() implementation pattern: check window exists, check electronAPI in window, verify not undefined. Uses contextBridge with contextIsolation.</snippet>
      </doc>
      <doc>
        <path>notes/architecture-electron-migration.md</path>
        <title>Electron Migration Architecture</title>
        <section>Implementation Patterns</section>
        <snippet>All Electron-only UI MUST use isElectron() guard pattern. Export as named export for tree-shaking.</snippet>
      </doc>
      <doc>
        <path>notes/epics-electron-migration.md</path>
        <title>Electron Migration Epics</title>
        <section>Story 2.1: Platform Detection Utility</section>
        <snippet>Story definition with user story format and acceptance criteria. Prerequisite: Story 1.2 (Electron dev mode with HMR).</snippet>
      </doc>
      <doc>
        <path>notes/prd-electron-migration.md</path>
        <title>Electron Migration PRD</title>
        <section>FR6: Runtime Electron detection</section>
        <snippet>Functional requirement for runtime detection of Electron vs browser environment.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>today-app/electron/preload.ts</path>
        <kind>preload-script</kind>
        <symbol>contextBridge.exposeInMainWorld</symbol>
        <lines>1-7</lines>
        <reason>Current stub exposes empty `window.electronAPI` object. Platform detection will check for this object's presence.</reason>
      </artifact>
      <artifact>
        <path>today-app/electron/main.ts</path>
        <kind>main-process</kind>
        <symbol>BrowserWindow webPreferences</symbol>
        <lines>13-18</lines>
        <reason>Confirms contextIsolation: true and nodeIntegration: false security settings that enable safe electronAPI exposure.</reason>
      </artifact>
      <artifact>
        <path>today-app/src/lib/db.ts</path>
        <kind>lib-module</kind>
        <symbol>TodayDatabase</symbol>
        <lines>1-98</lines>
        <reason>Example of existing lib module pattern. New platform.ts should follow same structure with proper exports and TypeScript types.</reason>
      </artifact>
      <artifact>
        <path>today-app/src/lib/timeFormatters.test.ts</path>
        <kind>test-file</kind>
        <symbol>describe, it, expect</symbol>
        <lines>1-50</lines>
        <reason>Test pattern reference: uses Vitest with describe/it/expect. Mock pattern for window object should follow project conventions.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <production>
          <package name="react" version="^19.2.0" />
          <package name="dexie" version="^4.2.1" />
        </production>
        <development>
          <package name="electron" version="^39.2.7" />
          <package name="electron-vite" version="^5.0.0" />
          <package name="@electron-toolkit/preload" version="^3.0.2" />
          <package name="@electron-toolkit/utils" version="^4.0.0" />
          <package name="typescript" version="~5.9.3" />
          <package name="vitest" version="^3.2.4" />
          <package name="@testing-library/react" version="^16.3.1" />
        </development>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="security">contextIsolation must remain true, nodeIntegration must remain false (ADR-007)</constraint>
    <constraint type="pattern">All Electron detection must use window.electronAPI presence check, not generic userAgent detection</constraint>
    <constraint type="build">Function must not break Vite web build or SSR phase - handle undefined window gracefully</constraint>
    <constraint type="export">Use named exports for tree-shaking: `export function isElectron()` or `export const isElectron =`</constraint>
    <constraint type="location">File must be at src/lib/platform.ts to match existing lib module organization</constraint>
    <constraint type="typing">Function must have explicit return type annotation `: boolean`</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>isElectron</name>
      <kind>function-signature</kind>
      <signature>export function isElectron(): boolean</signature>
      <path>today-app/src/lib/platform.ts (to be created)</path>
    </interface>
    <interface>
      <name>window.electronAPI</name>
      <kind>global-object</kind>
      <signature>Window.electronAPI?: { activity: { start, stop, getLog, export } }</signature>
      <path>today-app/electron/preload.ts (stub exists, methods added in Story 2.2)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Project uses Vitest for unit testing. Tests live alongside source files with `.test.ts` suffix.
      Use describe/it/expect pattern. Mock window object for environment simulation.
      Test edge cases: SSR (no window), browser (no electronAPI), Electron (has electronAPI).
      Run with `npm test` or `npm run test:run` for single pass.
    </standards>
    <locations>
      <location>today-app/src/lib/*.test.ts</location>
      <location>today-app/src/**/*.test.ts</location>
    </locations>
    <ideas>
      <testIdea ac="AC1.1">Verify platform.ts exports isElectron function</testIdea>
      <testIdea ac="AC1.2">Mock window.electronAPI present, verify returns true</testIdea>
      <testIdea ac="AC1.3">No electronAPI mock, verify returns false</testIdea>
      <testIdea ac="AC1.4">TypeScript compilation succeeds, return type is boolean</testIdea>
      <testIdea ac="AC1.5">Delete window global, verify returns false without throwing</testIdea>
      <testIdea ac="AC1.6">Run npm run build, verify no errors in output</testIdea>
    </ideas>
  </tests>
</story-context>
