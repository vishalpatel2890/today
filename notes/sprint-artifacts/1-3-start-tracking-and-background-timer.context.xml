<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Start Tracking and Background Timer</title>
    <status>drafted</status>
    <generatedAt>2026-01-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>notes/sprint-artifacts/1-3-start-tracking-and-background-timer.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>power user</asA>
    <iWant>to click "Track" after selecting a task</iWant>
    <soThat>time tracking starts in the background while I work</soThat>
    <tasks>
      <task id="1" acs="1,3,4,5,6">
        <name>Create useTimeTracking hook</name>
        <subtasks>
          <subtask>Create src/hooks/useTimeTracking.ts</subtask>
          <subtask>Implement state: activeSession, isTracking, isLoading</subtask>
          <subtask>Implement startTracking(taskId, taskName) function</subtask>
          <subtask>Create ActiveSession with taskId, taskName, startTime</subtask>
          <subtask>Call saveActiveSession to IndexedDB before updating state</subtask>
          <subtask>On mount, call loadActiveSession to restore session</subtask>
        </subtasks>
      </task>
      <task id="2" acs="3,5,7">
        <name>Create timeTrackingDb.ts IndexedDB operations</name>
        <subtasks>
          <subtask>Create src/lib/timeTrackingDb.ts</subtask>
          <subtask>Implement saveActiveSession(session)</subtask>
          <subtask>Implement loadActiveSession()</subtask>
          <subtask>Implement clearActiveSession()</subtask>
          <subtask>Use existing Dexie db instance, extend schema</subtask>
          <subtask>Ensure offline operation</subtask>
        </subtasks>
      </task>
      <task id="3" acs="1,2,8,9">
        <name>Integrate Track button in TimeTrackingModal</name>
        <subtasks>
          <subtask>Import and use useTimeTracking hook</subtask>
          <subtask>Connect Track onClick to startTracking(selectedTask.id, selectedTask.name)</subtask>
          <subtask>Close modal after startTracking completes</subtask>
          <subtask>Style Track button with bg-slate-600</subtask>
          <subtask>Add Enter key handler when task selected</subtask>
          <subtask>Verify no visible tracking indicator in main UI</subtask>
        </subtasks>
      </task>
      <task id="4" acs="5,6">
        <name>Handle session restoration on app load</name>
        <subtasks>
          <subtask>Add useEffect to load session on mount</subtask>
          <subtask>If session exists, set activeSession and isTracking = true</subtask>
          <subtask>Elapsed time is DERIVED: Date.now() - startTime</subtask>
          <subtask>Ensure modal shows active state after refresh</subtask>
        </subtasks>
      </task>
      <task id="5" acs="1,3,4,5,6">
        <name>Write unit tests for useTimeTracking hook</name>
        <subtasks>
          <subtask>Test startTracking creates ActiveSession</subtask>
          <subtask>Test startTracking calls saveActiveSession</subtask>
          <subtask>Test hook restores session on mount</subtask>
          <subtask>Test elapsed time calculation</subtask>
          <subtask>Test isTracking reflects session existence</subtask>
        </subtasks>
      </task>
      <task id="6" acs="3,5,7">
        <name>Write unit tests for timeTrackingDb</name>
        <subtasks>
          <subtask>Test saveActiveSession persists to IndexedDB</subtask>
          <subtask>Test loadActiveSession retrieves session</subtask>
          <subtask>Test clearActiveSession removes session</subtask>
          <subtask>Test operations with empty database</subtask>
        </subtasks>
      </task>
      <task id="7" acs="1-9">
        <name>Manual browser testing</name>
        <subtasks>
          <subtask>Test in Chrome: Track → refresh → session persists</subtask>
          <subtask>Test in Safari: same flow</subtask>
          <subtask>Test offline mode</subtask>
          <subtask>Verify no UI indicator in main app</subtask>
          <subtask>Run Frontend Test Gate checklist</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Clicking the "Track" button with a selected task starts the background timer and immediately closes the modal</criterion>
    <criterion id="2">The Track button uses primary button styling (slate-600 background) consistent with app design system</criterion>
    <criterion id="3">Active session is persisted to IndexedDB immediately before the modal closes (crash-resistant)</criterion>
    <criterion id="4">Active session stores: taskId, taskName (snapshot), and startTime (ISO 8601 timestamp)</criterion>
    <criterion id="5">When the browser is refreshed while tracking is active, the session is restored from IndexedDB</criterion>
    <criterion id="6">After browser refresh, elapsed time is calculated correctly from the original startTime (no drift)</criterion>
    <criterion id="7">Time tracking works offline (IndexedDB provides local-first persistence per FR46)</criterion>
    <criterion id="8">No visible timer or indicator appears in the main UI (hidden feature philosophy)</criterion>
    <criterion id="9">Pressing Enter when a task is selected triggers the Track button (keyboard-first interaction)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>notes/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>AC3, AC6</section>
        <snippet>AC3.1-3.4: Start tracking flow. AC6.1-6.4: Session persistence across browser refresh. Authoritative acceptance criteria for this story.</snippet>
      </doc>
      <doc>
        <path>notes/architecture-time-tracking.md</path>
        <title>Time Tracking Architecture</title>
        <section>ADR-TT-001, ADR-TT-005, Implementation Patterns</section>
        <snippet>ADR-TT-001: Store active session in IndexedDB immediately (crash-resistant). ADR-TT-005: Elapsed time derived from startTime, no accumulated drift. Hook pattern and TypeScript interfaces defined.</snippet>
      </doc>
      <doc>
        <path>notes/epics-time-tracking.md</path>
        <title>Time Tracking Epic Breakdown</title>
        <section>Story 1.3</section>
        <snippet>FR4: Background timer tracking. FR9: IndexedDB persistence. FR44: Persist across refresh. FR46: Offline functionality. Original story requirements.</snippet>
      </doc>
      <doc>
        <path>notes/ux-design-time-tracking.md</path>
        <title>Time Tracking UX Design</title>
        <section>5.1 Flow: Start Tracking, 3.1 Color System</section>
        <snippet>User flow: Select task → Click Track → Modal closes → Timer runs in background. Primary button: bg-slate-600 hover:bg-slate-700.</snippet>
      </doc>
      <doc>
        <path>notes/PRD-time-tracking.md</path>
        <title>Time Tracking PRD</title>
        <section>FR4, FR44, FR46, NFR7, NFR8</section>
        <snippet>FR4: Track elapsed time in background. FR44: Persist across refresh. FR46: Offline access. NFR7/8: Crash-resistant persistence.</snippet>
      </doc>
      <doc>
        <path>notes/sprint-artifacts/1-2-task-selection-dropdown-in-tracking-modal.md</path>
        <title>Previous Story 1.2</title>
        <section>Dev Agent Record</section>
        <snippet>TaskSelector component ready. Track button placeholder exists. selectedTask state available. Modal uses 320px width. All 77 tests pass.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>today-app/src/components/time-tracking/TimeTrackingModal.tsx</path>
        <kind>component</kind>
        <symbol>TimeTrackingModal</symbol>
        <lines>1-143</lines>
        <reason>Main modal component to modify. Has selectedTask state (line 28), handleTrack placeholder (lines 66-73). Track button exists but needs hook integration.</reason>
      </file>
      <file>
        <path>today-app/src/components/time-tracking/TaskSelector.tsx</path>
        <kind>component</kind>
        <symbol>TaskSelector, SelectedTask</symbol>
        <reason>Provides selected task data. SelectedTask type exported for type consistency.</reason>
      </file>
      <file>
        <path>today-app/src/types/timeTracking.ts</path>
        <kind>types</kind>
        <symbol>ActiveSession, TimeEntry</symbol>
        <lines>1-31</lines>
        <reason>ActiveSession interface already defined (lines 10-14). Use directly in useTimeTracking hook.</reason>
      </file>
      <file>
        <path>today-app/src/lib/db.ts</path>
        <kind>database</kind>
        <symbol>TodayDatabase, db</symbol>
        <lines>57-77</lines>
        <reason>Existing Dexie database. May need schema extension for activeSession store, or create separate timeTrackingDb.ts using same Dexie pattern.</reason>
      </file>
      <file>
        <path>today-app/src/hooks/useTimeTrackingHotkeys.ts</path>
        <kind>hook</kind>
        <symbol>useTimeTrackingHotkeys</symbol>
        <lines>1-116</lines>
        <reason>Reference for hook patterns. Shows callback ref pattern (lines 47-55) for stable callbacks.</reason>
      </file>
      <file>
        <path>today-app/src/hooks/useTasks.ts</path>
        <kind>hook</kind>
        <symbol>useTasks</symbol>
        <reason>Reference for existing hook patterns in the codebase.</reason>
      </file>
    </code>
    <dependencies>
      <npm>
        <package name="react" version="^19.2.0">Component framework, useState, useEffect hooks</package>
        <package name="dexie" version="^4.2.1">IndexedDB wrapper for activeSession persistence</package>
        <package name="dexie-react-hooks" version="^4.2.0">React integration for Dexie (useLiveQuery if needed)</package>
        <package name="date-fns" version="^4.1.0">Date formatting, ISO timestamp handling</package>
        <package name="@radix-ui/react-dialog" version="^1.1.15">Modal component (already used)</package>
      </npm>
      <devDependencies>
        <package name="vitest" version="^3.2.4">Test runner</package>
        <package name="fake-indexeddb" version="^6.2.5">IndexedDB mocking for unit tests</package>
        <package name="@testing-library/react" version="^16.3.1">Component testing</package>
      </devDependencies>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="ADR-TT-001">Store active session in IndexedDB immediately on tracking start - crash-resistant, single storage mechanism</constraint>
    <constraint source="ADR-TT-005">Elapsed time calculated as Date.now() - startTime on each render - no accumulated drift</constraint>
    <constraint source="Architecture">IndexedDB write must complete before updating React state</constraint>
    <constraint source="Architecture">Hook exports: activeSession, isTracking, isLoading, startTracking</constraint>
    <constraint source="UX">No visible tracking indicator in main UI - hidden feature philosophy</constraint>
    <constraint source="UX">Track button: bg-slate-600 hover:bg-slate-700 text-white (primary button)</constraint>
    <constraint source="NFR4">Timer display only updates when modal is open (battery friendly)</constraint>
    <constraint source="NFR7">Active tracking must persist through app backgrounding</constraint>
    <constraint source="NFR8">No data loss on unexpected app termination</constraint>
    <constraint source="NFR9">Timer accuracy within ±1 second over extended sessions</constraint>
    <constraint source="Coding Pattern">Functional components with TypeScript, arrow function syntax, named exports</constraint>
    <constraint source="Coding Pattern">Use existing patterns from useTimeTrackingHotkeys for callback refs</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>useTimeTracking</name>
      <kind>React Hook</kind>
      <signature>function useTimeTracking(): { activeSession: ActiveSession | null; isTracking: boolean; isLoading: boolean; startTracking: (taskId: string, taskName: string) => Promise&lt;void&gt;; }</signature>
      <path>today-app/src/hooks/useTimeTracking.ts (NEW)</path>
    </interface>
    <interface>
      <name>saveActiveSession</name>
      <kind>IndexedDB Operation</kind>
      <signature>async function saveActiveSession(session: ActiveSession): Promise&lt;void&gt;</signature>
      <path>today-app/src/lib/timeTrackingDb.ts (NEW)</path>
    </interface>
    <interface>
      <name>loadActiveSession</name>
      <kind>IndexedDB Operation</kind>
      <signature>async function loadActiveSession(): Promise&lt;ActiveSession | null&gt;</signature>
      <path>today-app/src/lib/timeTrackingDb.ts (NEW)</path>
    </interface>
    <interface>
      <name>clearActiveSession</name>
      <kind>IndexedDB Operation</kind>
      <signature>async function clearActiveSession(): Promise&lt;void&gt;</signature>
      <path>today-app/src/lib/timeTrackingDb.ts (NEW)</path>
    </interface>
    <interface>
      <name>ActiveSession</name>
      <kind>TypeScript Interface</kind>
      <signature>interface ActiveSession { taskId: string; taskName: string; startTime: string; }</signature>
      <path>today-app/src/types/timeTracking.ts</path>
    </interface>
    <interface>
      <name>SelectedTask</name>
      <kind>TypeScript Type</kind>
      <signature>type SelectedTask = { id: string; name: string; } | null</signature>
      <path>today-app/src/components/time-tracking/TaskSelector.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Tests use Vitest with React Testing Library. IndexedDB tests use fake-indexeddb for mocking. Follow existing test patterns in TaskSelector.test.tsx and useTimeTrackingHotkeys.test.ts. Tests live alongside source files (co-located pattern: *.test.ts/tsx).
    </standards>
    <locations>
      <location>today-app/src/hooks/useTimeTracking.test.ts (NEW)</location>
      <location>today-app/src/lib/timeTrackingDb.test.ts (NEW)</location>
    </locations>
    <ideas>
      <idea ac="1">Test startTracking closes modal by verifying onOpenChange(false) is called</idea>
      <idea ac="3">Test saveActiveSession persists to IndexedDB using fake-indexeddb</idea>
      <idea ac="4">Test ActiveSession has correct shape: taskId, taskName, startTime (ISO format)</idea>
      <idea ac="5">Test loadActiveSession restores session on hook mount</idea>
      <idea ac="6">Test elapsed time calculation: mock Date.now, verify derived correctly</idea>
      <idea ac="7">Test IndexedDB operations work without network (inherent to IndexedDB)</idea>
      <idea ac="9">Test Enter key triggers Track when task is selected</idea>
      <idea>Integration test: startTracking → refresh simulation → session restored</idea>
      <idea>Edge case: startTracking called when no task selected (should be prevented by UI)</idea>
    </ideas>
  </tests>
</story-context>
